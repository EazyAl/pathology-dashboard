name: 'Selenium Web E2E Tests'

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test-e2e-selenium-web:
    runs-on: ubuntu-latest
    name: 'E2E Tests (Selenium Web)'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile
          cd webdriver/selenium && pnpm install

      - name: Build frontend
        run: pnpm build

      - name: Start Next.js server
        run: |
          pnpm start &
          sleep 15

      - name: Run Selenium Web Tests
        run: |
          cd webdriver/selenium
          # Create a simple web test that doesn't require Tauri
          cat > test/web-test.js << 'EOF'
          const { Builder, By, until } = require('selenium-webdriver');
          const { expect } = require('chai');

          describe('Rainpath Web Interface', () => {
            let driver;

            before(async function() {
              this.timeout(30000);
              driver = await new Builder()
                .forBrowser('chrome')
                .usingServer('http://localhost:4444/wd/hub')
                .build();
            });

            after(async function() {
              if (driver) await driver.quit();
            });

            it('should load the web interface', async () => {
              await driver.get('http://localhost:3000');
              const title = await driver.getTitle();
              expect(title).to.include('rainpath');
            });

            it('should have search functionality', async () => {
              await driver.get('http://localhost:3000');
              const searchInput = await driver.findElement(By.css('input[type="number"]'));
              expect(searchInput).to.exist;
            });
          });
          EOF
          
          # Install Chrome driver
          sudo apt-get update
          sudo apt-get install -y chromium-browser
          
          # Run tests with Chrome
          CHROME_BIN=/usr/bin/chromium-browser pnpm test test/web-test.js

      - name: Upload test screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-screenshots
          path: webdriver/selenium/test/screenshots/ 